#!/bin/bash
# Backup cleanup script - Generated by Ansible

set -e

# Check parameters
if [ $# -lt 2 ]; then
  echo "Usage: $0 <backup_type> <days_to_keep>"
  exit 1
fi

BACKUP_TYPE=$1
DAYS_TO_KEEP=$2
BACKUP_DIR="{{ backup_base_dir }}/${BACKUP_TYPE}"

if [ ! -d "${BACKUP_DIR}" ]; then
  echo "Backup directory does not exist: ${BACKUP_DIR}"
  exit 1
fi

echo "Starting cleanup of ${BACKUP_TYPE} backups at $(date)"
echo "Keeping the last ${DAYS_TO_KEEP} days of backups"

# Find and delete old backups
find "${BACKUP_DIR}" -type f -name "*.tar.gz*" -o -name "*.sql.gz*" -mtime +${DAYS_TO_KEEP} | while read file; do
  echo "Deleting old backup: ${file}"
  rm -f "${file}"
done

# Print summary
REMAINING=$(find "${BACKUP_DIR}" -type f | wc -l)
echo "Cleanup completed at $(date)"
echo "Remaining backups: ${REMAINING}"